<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Search Results</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="../style.css">
  <style>
    body {
      padding: 1rem;
      background: #111;
      color: #eee;
    }

    #warningBox {
      color: orange;
      margin-bottom: 1rem;
      padding: 0.6rem 0.8rem;
      border: 1px solid #444;
      border-radius: 8px;
      background: rgba(255, 165, 0, 0.06);
    }

    a { color: #daa520; }

    a.file-link {
      color: #b19cd9;
      text-decoration: none;
    }
    a.file-link:hover {
      color: #d8c5f0;
      text-decoration: underline;
    }

    .table-wrap{
      width: 90%;
      margin: 0 auto 2rem auto;
      max-height: 72vh;        
    }

    table.result-table {
      border-collapse: collapse;
      width: 100%;
      min-width: 980px; /* helps prevent squish on narrow screens */
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }

    table.result-table th,
    table.result-table td {
      vertical-align: top;
      border: 1px solid #444;
      padding: 8px 10px;
      text-align: left;
      line-height: 1.35;
    }

    /* sticky header row — search results */
    .table-wrap table thead tr:first-child > th {
      position: sticky;
      top: 0px;                 /* align with navbar */
      z-index: 5;

      color: #FFFF00;
      background: #111;
      opacity: 1;


      line-height: 1.25;
      font-size: 1.15em;
      font-weight: 600;

      /* reliable 4-side border + depth */
      box-shadow:
        inset 0 -2px 0 black,
        inset 0  2px 0 black,
        inset -2px 0 0 black,
        inset 2px  0 0 black;
    }

    /* Color consistency */
    .col-wei { background: rgba(0, 204, 153, 0.12); }
    .col-shu { background: rgba(181, 126, 255, 0.12); }
    .col-wu  { background: rgba(255, 140, 64, 0.12); }

    .table-wrap table thead tr:first-child > th.col-wei { background-color: #0b3b33; }
    .table-wrap table thead tr:first-child > th.col-shu { background-color: #2d2440; }
    .table-wrap table thead tr:first-child > th.col-wu  { background-color: #3b2a1b; }


    /* hover helps scan across columns */
    table.result-table tbody tr:hover td{
      background: rgba(255,255,255,0.04);
    }

    /* Action column */
    .action-cell{
      white-space: nowrap;
      min-width: 260px;
    }

    .copy-btn{
      background: transparent;
      color: #eee;
      border: 1px solid #666;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      margin-right: 10px;
      font-size: 0.85rem;
    }
    .copy-btn:hover{
      border-color: #999;
    }

    /* Subtle divider above results */
    .meta-line{
      opacity: 0.9;
      margin: 0.25rem 0 0.5rem 0;
    }

    hr {
      border: 0;
      border-top: 1px solid #333;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <h2 id="pageTitle"></h2>
  <div id="warningBox" style="display:none;"></div>
  <div id="resultBox"></div>

  <script>
    // --- Retrieve payload from localStorage ---
    const payload = JSON.parse(localStorage.getItem("positionSearchResults") || "{}");
    const lang = payload.lang || "en";

    // --- File labels mapping ---
    const FILE_LABELS = {
      "excellencies_ministers_webdisplay.json": {
        label: "公卿 Excellencies & Ministers",
        url: {
          zh: "../zh/excellencies_ministers_zh.html",
          en: "../translations/excellencies_ministers.html"
        }
      },
      "rear_eastern_palace_webdisplay.json": {
        label: "后宮東宮 Rear & Eastern Palaces",
        url: {
          zh: "../zh/rear_eastern_palace_zh.html",
          en: "../translations/rear_eastern_palace.html"
        }
      },
      "central_court_webdisplay.json": {
        label: "中朝臺省表 Privy Court & Departmental Officials",
        url: {
          zh: "../zh/central_court_zh.html",
          en: "../translations/central_court.html"
        }
      },
      "military_officials_webdisplay.json": {
        label: "武將表 Military Officials",
        url: {
          zh: "../zh/military_officials_zh.html",
          en: "../translations/military_officials.html"
        }
      },
      "provincial_officials_webdisplay.json": {
        label: "外官表 Provincial Officials",
        url: {
          zh: "../zh/provincial_officials_zh.html",
          en: "../translations/provincial_officials.html"
        }
      }
    };

    function getFileLink(fileName, sheetName, lang) {
      const info = FILE_LABELS[fileName];
      if (!info) {
        return { label: `${fileName} → ${sheetName}`, url: "#" };
      }
      const label = `${info.label} → ${sheetName}`;
      const baseUrl = info.url[lang] || "#";

      // pass sheet name so destination page can auto-select it later
      const fullUrl = `${baseUrl}?sheet=${encodeURIComponent(sheetName)}&file=${encodeURIComponent(fileName)}`;
      return { label, url: fullUrl };
    }

    // --- UI Labels ---
    document.getElementById("pageTitle").innerText =
      lang === "zh" ? "檢索結果" : "Search Results";
    document.title = lang === "zh" ? "檢索結果" : "Search Results";

    // --- Show warning if present ---
    if (payload.warning) {
      const warningBox = document.getElementById("warningBox");
      warningBox.style.display = "block";
      warningBox.innerText = payload.warning;
    }

    const resultBox = document.getElementById("resultBox");

    // --- Copy helper (TSV = Excel-friendly) ---
    window.copyRow = async function(btn){
      const tr = btn.closest("tr");
      const text = tr?.getAttribute("data-copy") || "";

      try {
        await navigator.clipboard.writeText(text);
        const old = btn.textContent;
        btn.textContent = "✓";
        setTimeout(() => btn.textContent = old, 900);
      } catch (e) {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        const old = btn.textContent;
        btn.textContent = "✓";
        setTimeout(() => btn.textContent = old, 900);
      }
    };

    // --- Render results (single table) ---
    if (!payload.results || !payload.results.length) {
      resultBox.innerHTML = lang === "zh"
        ? "<p>未找到相關內容。</p>"
        : "<p>No matching results found.</p>";
    } else {
      const actionLabel = lang === "zh" ? "操作" : "Actions";
      const copyLabel   = lang === "zh" ? "複製" : "Copy row";

      let html = `
        <div class="table-wrap">
          <table class="result-table">
            <thead>
              <tr>
                <th class="col-wei">名(魏)</th>
                <th class="col-wei">Name (Wei)</th>
                <th class="col-shu">名(蜀)</th>
                <th class="col-shu">Name (Shu)</th>
                <th class="col-wu">名(吳)</th>
                <th class="col-wu">Name (Wu)</th>
                <th>${actionLabel}</th>
              </tr>
            </thead>

            <tbody>
      `;

      html += payload.results.map((r) => {
        const link = getFileLink(r.file, r.sheet, lang);

        // Copy ONLY row content (no headers), TSV for easy paste into Excel
        const copyText = [
          r.weiZ || "", r.weiE || "",
          r.shuZ || "", r.shuE || "",
          r.wuZ  || "", r.wuE  || ""
        ].join("\t");

        // Escape quotes for attribute
        const safeCopy = copyText.replace(/"/g, "&quot;");

        return `
          <tr data-copy="${safeCopy}">
            <td class="col-wei">${r.weiZ || ""}</td>
            <td class="col-wei">${r.weiE || ""}</td>
            <td class="col-shu">${r.shuZ || ""}</td>
            <td class="col-shu">${r.shuE || ""}</td>
            <td class="col-wu">${r.wuZ || ""}</td>
            <td class="col-wu">${r.wuE || ""}</td>

            <td class="action-cell">
              <button type="button" class="copy-btn" onclick="copyRow(this)">
                ${copyLabel}
              </button>

              <div class="goto-line">
                <br>
                <a class="file-link" href="${link.url}" target="_blank">
                  <i class="fa-solid fa-arrow-up-right-from-square goto-icon"></i>
                  ${link.label}
                </a>
              </div>
            </td>

          </tr>
        `;
      }).join("");

      html += `
            </tbody>
          </table>
        </div>
      `;

      resultBox.innerHTML = html;
    }
  </script>
</body>
</html>
